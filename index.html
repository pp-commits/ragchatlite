<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Chat</title>

  <style>
    body {
      margin: 0;
      background: #f7f7f8;
      font-family: "Inter", sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

   
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 15px;
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

 
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 14px;
      margin-bottom: 14px;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .user {
      background: #DCF2FF;
      align-self: flex-end;
    }

    .bot {
      background: white;
      border: 1px solid #e5e5e5;
      align-self: flex-start;
    }

    
    .input-container {
      display: flex;
      padding: 14px;
      gap: 10px;
      background: #ffffff;
      border-top: 1px solid #ddd;
    }

    .input-container input {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ddd;
      outline: none;
    }

    .input-container button {
      padding: 14px 20px;
      font-size: 16px;
      border: none;
      background: #10a37f;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }

    .input-container button:hover {
      background: #0e8d6e;
    }
  </style>
</head>

<body>

  <div class="chat-container" id="chat"></div>

  <div class="input-container">
    <input id="query" placeholder="Ask something..." />
    <button onclick="ask()">Send</button>
  </div>

<script>

document.getElementById("query").addEventListener("keydown", function (event) {
  if (event.key === "Enter") {
    event.preventDefault();
    ask();
  }
});

function appendMessage(text, type) {
  const chat = document.getElementById("chat");
  const msg = document.createElement("div");
  msg.classList.add("message", type);
  msg.textContent = text;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
  return msg;
}


window.onload = () => {
  appendMessage(
    "Hey, how are you feeling today?\nAsk me anything if you need help…",
    "bot"
  );
};

// RAG Knowledge Base
const documents = [
  {
    title: "AI Basics",
    text: "AI means building systems that mimic human intelligence.",
    metadata: {
      topic: "ai",
      category: "fundamentals",
      tags: ["ai", "basics", "intelligence"],
      level: "beginner",
    }
  },
  {
    title: "RAG Definition",
    text: "RAG combines retrieval with LLM generation for accuracy.",
    metadata: {
      topic: "rag",
      category: "architecture",
      tags: ["rag", "retrieval", "generation"],
      level: "intermediate",
    }
  },
  {
    title: "Embeddings",
    text: "Embeddings convert text into numeric vectors capturing meaning.",
    metadata: {
      topic: "embeddings",
      category: "semantic",
      tags: ["embeddings", "vectors", "similarity"],
      level: "intermediate",
    }
  }
];


// Simple retriever
function retrieve(query) {
  const q = query.toLowerCase();
  const stopwords = ["what", "is", "the", "a", "an", "of", "explain", "define"];
  const qWords = q.split(" ").filter(w => w.trim() && !stopwords.includes(w));

  let bestDoc = null;
  let bestScore = -Infinity;

  for (const doc of documents) {
    let score = 0;

    const text = doc.text.toLowerCase();
    const title = doc.title.toLowerCase();
    const meta = doc.metadata;

    qWords.forEach(word => {
      // ---- TEXT / TITLE MATCHING ----
      if (text.includes(" " + word + " ") || text.startsWith(word + " ") || text.endsWith(" " + word))
        score += 5;

      if (title.includes(word))
        score += 10;

      if (word.length >= 4 && text.includes(word.slice(0, 4)))
        score += 2;

      // ---- METADATA MATCHING ----

      
      if (meta.topic.includes(word))
        score += 15;

      
      meta.tags.forEach(tag => {
        if (tag === word) score += 10;
        if (tag.includes(word) || word.includes(tag)) score += 6;
      });

      
      if (meta.category.includes(word))
        score += 5;

      
      if (meta.level.includes(word))
        score += 3;
    });

    // If doc has absolutely no relation → penalize
    if (score < 5) score -= 8;

    
    score -= (text.length * 0.0002);

    if (score > bestScore) {
      bestScore = score;
      bestDoc = doc;
    }
  }

  return bestDoc;
}


// Streaming simulation
async function stream(text, callback) {
  const words = text.split(" ");
  for (let w of words) {
    callback(w + " ");
    await new Promise(res => setTimeout(res, 50));
  }
}

// Main Ask Handler
async function ask() {
  const query = document.getElementById("query").value.trim();
  if (!query) return;

  appendMessage(query, "user");

  const botMsg = appendMessage("", "bot");

  const doc = retrieve(query);

  const final =
    `Using info from "${doc.title}":\n\n` +
    doc.text +
    `\n\nAnswering your question: ${query}\n\n`;

  await stream(final, chunk => {
    botMsg.textContent += chunk;
    document.getElementById("chat").scrollTop = chat.scrollHeight;
  });

  document.getElementById("query").value = "";
}
</script>

</body>
</html>
